rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==========================================================
    // FUNÇÕES DE VALIDAÇÃO (Regras de Negócio)
    // ==========================================================

    // Valida os Tipos de Eventos permitidos
    function isValidEventType(type) {
      return type in [
        'TI', 
        'Evento Interno', 
        'Evento Externo', 
        'Campanha', 
        'Treinamento', 
        'Gravação Externa'
      ];
    }

    // Valida os Públicos permitidos
    function isValidAudience(audience) {
      return audience in [
        'Externo', 
        'Interno', 
        'Parceria', 
        'Visitante', 
        'Colaborador'
      ];
    }

    // Valida os Status permitidos
    function isValidStatus(status) {
      return status in [
        'Planejado', 
        'Em Execução', 
        'Concluído', 
        'Cancelado'
      ];
    }

    // Valida os Níveis de Risco (Módulo de Crises)
    function isValidRiskLevel(level) {
      return level in [
        'Sem relevância crítica', 
        'Leve', 
        'Moderada', 
        'Potencial', 
        'Grave', 
        'Reputacional Extrema'
      ];
    }

    // Valida a Origem da Crise
    function isValidOrigin(origin) {
      return origin in ['Interno', 'Externo', 'Misto'];
    }

    // Valida os Setores Envolvidos (Módulo de Crises)
    function isValidSector(sector) {
      return sector in [
        'Comunicação', 
        'Central', 
        'Infraestrutura', 
        'Administração', 
        'RH', 
        'Externo'
      ];
    }

    // Valida os Responsáveis Autorizados (Regra de Governança)
    function isValidResponsible(name) {
      return name in ['Vera Nascimento', 'Gisely Rocha'];
    }

    // ==========================================================
    // REGRAS POR COLEÇÃO
    // ==========================================================

    // 1. Ações do Mês (activities)
    match /activities/{activityId} {
      allow read: if true; // Ajustar para 'if request.auth != null' em produção
      
      allow create, update: if 
        // Campos obrigatórios devem estar presentes e válidos
        isValidEventType(request.resource.data.type) &&
        isValidAudience(request.resource.data.audience) &&
        isValidStatus(request.resource.data.status) &&
        // Validação da Meta de Satisfação (0 a 100) se preenchida
        (
          !('satisfaction' in request.resource.data) || 
          (request.resource.data.satisfaction >= 0 && request.resource.data.satisfaction <= 100)
        );
        
      allow delete: if true; // A confirmação visual (pop-up) é garantida no Frontend
    }

    // 2. Gestão de Riscos & Crises (crises)
    match /crises/{crisisId} {
      allow read: if true;
      
      allow create, update: if 
        // Garante integridade e governança dos dados sensíveis
        isValidRiskLevel(request.resource.data.riskLevel) &&
        isValidOrigin(request.resource.data.origin) &&
        isValidSector(request.resource.data.sector) &&
        isValidResponsible(request.resource.data.responsible);
        
      allow delete: if true;
    }

    // 3. Datas Comemorativas (holidays)
    match /holidays/{holidayId} {
      // Dados de inserção manual simples
      allow read, write: if true; 
    }

    // 4. Relatórios Mensais (monthlyReports)
    match /monthlyReports/{reportId} {
      // Textos de análise e métricas consolidadas
      allow read, write: if true;
    }
  }
}
    
           
