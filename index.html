
<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assessoria de Comunicação Evereste</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fontes e Estilos Globais -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #0f172a;
        }

        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Impressão Otimizada */
        @media print {
            @page { margin: 0.5cm; size: portrait; }
            body { 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact; 
                background-color: white;
                font-size: 10px; 
            }
            #app-content { width: 100% !important; padding: 0 !important; margin: 0 !important; display: block !important; }
            #mobile-menu, header, footer, .no-print { display: none !important; }
            table { font-size: 9px; width: 100%; table-layout: fixed; }
            th, td { padding: 4px 2px !important; word-wrap: break-word; border: 1px solid #e2e8f0 !important; }
            input, select, textarea { border: none !important; background: transparent !important; padding: 0 !important; resize: none; -webkit-appearance: none; }
            .bg-blue-100 { background-color: #dbeafe !important; }
            .bg-blue-900 { background-color: #1e3a8a !important; color: white !important; }
            .bg-green-100 { background-color: #dcfce7 !important; }
            .bg-red-100 { background-color: #fee2e2 !important; }
        }

        #modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
        .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }

        .nav-btn-active { background-color: #ffffff !important; color: #1e3a8a !important; font-weight: 700; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .nav-btn-inactive { color: #dbeafe !important; }
        .nav-btn-inactive:hover { background-color: #1d4ed8 !important; color: #ffffff !important; }
    </style>
</head>
<body class="pb-12 h-screen flex flex-col">

    <!-- Modal de Confirmação -->
    <div id="modal-overlay" class="fixed inset-0 flex items-center justify-center z-50 hidden no-print bg-black/50 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full border border-red-100 animate-fadeIn">
            <h3 class="text-lg font-bold text-gray-900 mb-2 flex items-center gap-2">
                <i data-lucide="alert-triangle" class="text-red-500"></i> Confirmação
            </h3>
            <p id="modal-message" class="text-gray-600 mb-6">Tem a certeza?</p>
            <div class="flex justify-end gap-3">
                <button onclick="window.closeModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancelar</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white hover:bg-red-700 rounded-lg shadow-sm">Sim, Apagar</button>
            </div>
        </div>
    </div>

    <div id="app-wrapper" class="flex-1 flex flex-col">
        <!-- Header -->
        <header class="bg-blue-900 text-white shadow-lg sticky top-0 z-40 no-print">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-white rounded flex items-center justify-center text-blue-900 font-bold shadow-sm">AE</div>
                    <div>
                        <h1 class="text-lg font-bold leading-none">Evereste</h1>
                        <p class="text-xs text-blue-200 mt-1">Gestão Integrada 2026</p>
                    </div>
                </div>

                <nav class="hidden md:flex gap-1 bg-blue-800/50 p-1 rounded-lg">
                    <button onclick="window.changeView('dashboard')" class="nav-btn px-4 py-2 rounded-md text-sm font-medium transition-all" data-view="dashboard">Dashboard</button>
                    <button onclick="window.changeView('month')" class="nav-btn px-4 py-2 rounded-md text-sm font-medium transition-all" data-view="month">Ações</button>
                    <button onclick="window.changeView('calendar')" class="nav-btn px-4 py-2 rounded-md text-sm font-medium transition-all" data-view="calendar">Calendário</button>
                    <button onclick="window.changeView('reports')" class="nav-btn px-4 py-2 rounded-md text-sm font-medium transition-all" data-view="reports">Relatórios</button>
                    <button onclick="window.changeView('crisis')" class="nav-btn px-4 py-2 rounded-md text-sm font-medium transition-all" data-view="crisis">Riscos</button>
                </nav>

                <div class="flex items-center gap-2">
                    <span id="connection-status-dot" class="w-2 h-2 rounded-full bg-gray-400"></span>
                    <span id="user-display" class="text-xs text-blue-200 hidden md:block">A carregar...</span>
                    <button class="md:hidden p-2 text-white" onclick="window.toggleMobileMenu()"><i data-lucide="menu"></i></button>
                </div>
            </div>
        </header>

        <main id="app-content" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full flex-1">
            <div id="loading-spinner" class="text-center py-20 text-gray-500">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-900 mb-4"></div>
                <p>Sincronizando com o painel unificado...</p>
            </div>
        </main>

        <footer class="hidden print:block text-center text-[8px] text-gray-400 mt-8 border-t pt-2">
            Assessoria de Comunicação Evereste - Documento Gerado em <span id="print-date"></span>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

        // --- CONFIGURAÇÃO ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'evereste-gestao-2026';

        window.state = {
            view: 'dashboard',
            selectedMonth: new Date().getMonth(),
            activities: [],
            crises: [],
            notifications: [],
            monthlyReports: {},
            holidays: [],
            user: null
        };

        let db, auth;

        // --- FUNÇÕES DE TEMPLATE (Guarantido Global) ---

        const getDashboardHTML = () => {
            const acts = window.state.activities;
            const completed = acts.filter(a => a.status === 'Concluído').length;
            const rated = acts.filter(a => a.satisfaction && !isNaN(a.satisfaction));
            const avg = rated.length ? Math.round(rated.reduce((acc, c) => acc + parseFloat(c.satisfaction), 0) / rated.length) : 0;
            const top = [...acts].filter(a => a.satisfaction).sort((a,b) => b.satisfaction - a.satisfaction).slice(0,5);

            return `
                <div class="space-y-6 animate-fadeIn">
                    <div class="flex justify-between items-center border-b pb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Painel Geral</h2>
                        <button onclick="window.exportPDF()" class="bg-blue-600 text-white px-4 py-2 rounded flex gap-2 items-center text-sm no-print shadow-sm hover:bg-blue-700 transition">
                            <i data-lucide="printer" size="16"></i> Imprimir Relatório
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-white p-5 rounded-lg shadow-sm border-l-4 border-blue-600">
                            <p class="text-xs text-gray-500 font-bold uppercase">Média Satisfação</p>
                            <h3 class="text-3xl font-bold text-gray-800">${avg}%</h3>
                        </div>
                        <div class="bg-white p-5 rounded-lg shadow-sm border-l-4 border-green-500">
                            <p class="text-xs text-gray-500 font-bold uppercase">Ações Concluídas</p>
                            <h3 class="text-3xl font-bold text-gray-800">${completed}</h3>
                        </div>
                        <div class="bg-white p-5 rounded-lg shadow-sm border-l-4 border-red-500">
                            <p class="text-xs text-gray-500 font-bold uppercase">Riscos Ativos</p>
                            <h3 class="text-3xl font-bold text-gray-800">${window.state.crises.length}</h3>
                        </div>
                        <div class="bg-white p-5 rounded-lg shadow-sm border-l-4 border-indigo-500">
                            <p class="text-xs text-gray-500 font-bold uppercase">Total Planejado</p>
                            <h3 class="text-3xl font-bold text-gray-800">${acts.length}</h3>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100 flex flex-col">
                            <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><i data-lucide="award" class="text-yellow-500"></i> Melhores Avaliados</h3>
                            <div class="space-y-3">
                                ${top.map(t => `<div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                    <span class="text-sm font-medium truncate pr-4">${t.eventName || 'Evento s/ nome'}</span>
                                    <span class="text-sm font-bold text-green-600">${t.satisfaction}%</span>
                                </div>`).join('') || '<p class="text-sm text-gray-400 italic">Nenhuma avaliação registada.</p>'}
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100">
                            <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><i data-lucide="bell" class="text-blue-500"></i> Mural de Avisos</h3>
                            <div class="flex gap-2 mb-4 no-print">
                                <input type="text" id="notif-input" placeholder="Novo aviso..." class="flex-1 border p-2 rounded text-sm outline-none focus:ring-1 focus:ring-blue-500">
                                <button onclick="window.sendNotif()" class="bg-blue-900 text-white px-3 py-2 rounded text-sm">Postar</button>
                            </div>
                            <div class="max-h-60 overflow-y-auto custom-scrollbar space-y-2">
                                ${window.state.notifications.map(n => `<div class="p-3 bg-yellow-50 border-l-2 border-yellow-400 rounded flex justify-between group">
                                    <div><p class="text-sm text-yellow-800">${n.text}</p><span class="text-[9px] text-yellow-600 uppercase font-bold">${new Date(n.timestamp).toLocaleString()}</span></div>
                                    <button onclick="window.deleteNotification('${n.id}')" class="text-yellow-400 opacity-0 group-hover:opacity-100 hover:text-red-500 transition"><i data-lucide="x" size="14"></i></button>
                                </div>`).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const getMonthViewHTML = () => {
            const m = MONTHS_DATA[window.state.selectedMonth];
            const filteredActs = window.state.activities.filter(a => parseInt(a.month) === m.id);
            const filteredHolidays = window.state.holidays.filter(h => parseInt(h.month) === m.id);

            return `
                <div class="space-y-6 animate-fadeIn">
                    <div class="bg-white p-6 rounded-lg shadow-sm ${m.color}">
                        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                            <h2 class="text-2xl font-bold text-gray-800 uppercase tracking-wide">${m.name} 2026</h2>
                            <div class="flex gap-2 no-print">
                                <button onclick="window.addActivity()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold flex gap-2 items-center hover:bg-blue-700 transition shadow-sm">
                                    <i data-lucide="plus-circle" size="18"></i> Adicionar Ação
                                </button>
                                <button onclick="window.exportPDF()" class="bg-gray-100 text-gray-600 px-4 py-2 rounded-lg font-bold flex gap-2 items-center hover:bg-gray-200 transition">
                                    <i data-lucide="printer" size="18"></i> PDF
                                </button>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-100">
                            <div class="flex flex-wrap gap-2">
                                <div class="no-print flex gap-1 mr-2">
                                    <input id="h-day" type="text" placeholder="Dia" class="w-10 border rounded p-1 text-xs">
                                    <input id="h-name" type="text" placeholder="Data Comemorativa" class="w-32 border rounded p-1 text-xs">
                                    <button onclick="window.addHoliday()" class="bg-gray-800 text-white px-2 py-1 rounded text-xs">Add</button>
                                </div>
                                ${filteredHolidays.map(h => `<span class="bg-blue-50 text-blue-800 px-3 py-1 rounded-full text-xs border border-blue-100 flex items-center gap-1 font-medium"><b>${h.day}</b> - ${h.name} <i onclick="window.removeHoliday('${h.id}')" data-lucide="x" size="10" class="cursor-pointer hover:text-red-500 no-print"></i></span>`).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="overflow-x-auto custom-scrollbar">
                            <table class="w-full text-left text-sm whitespace-nowrap">
                                <thead class="bg-gray-50 text-gray-500 font-bold uppercase text-[10px]">
                                    <tr>
                                        <th class="px-4 py-3 min-w-[140px]">Tipo</th>
                                        <th class="px-4 py-3 min-w-[180px]">Nome do Evento</th>
                                        <th class="px-4 py-3 min-w-[165px]">Data e Hora</th>
                                        <th class="px-4 py-3 min-w-[120px]">Público</th>
                                        <th class="px-4 py-3 min-w-[140px]">Setor Responsável</th>
                                        <th class="px-4 py-3 min-w-[180px]">Descrição Ocorrência</th>
                                        <th class="px-4 py-3 min-w-[100px]">Satisfação</th>
                                        <th class="px-4 py-3 min-w-[120px]">Status</th>
                                        <th class="px-4 py-3 w-12 no-print"></th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    ${filteredActs.map(a => `
                                        <tr class="hover:bg-blue-50/30 transition-colors">
                                            <td class="px-4 py-3">
                                                <select onchange="window.saveField('${a.id}', 'type', this.value)" class="w-full p-1 border rounded text-xs font-bold bg-white">
                                                    ${EVENT_TYPES.map(opt => `<option ${a.type === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                                </select>
                                            </td>
                                            <td class="px-4 py-3">
                                                <input type="text" value="${a.eventName || ''}" onblur="window.saveField('${a.id}', 'eventName', this.value)" class="w-full p-1 border rounded text-xs font-medium" placeholder="Digitar...">
                                            </td>
                                            <td class="px-4 py-3">
                                                <div class="flex flex-col gap-1">
                                                    <input type="date" value="${a.date || ''}" min="2026-01-01" max="2026-12-31" onchange="window.saveField('${a.id}', 'date', this.value)" class="p-1 border rounded text-[10px]">
                                                    <input type="time" value="${a.time || ''}" onchange="window.saveField('${a.id}', 'time', this.value)" class="p-1 border rounded text-[10px]">
                                                </div>
                                            </td>
                                            <td class="px-4 py-3">
                                                <select onchange="window.saveField('${a.id}', 'audience', this.value)" class="w-full p-1 border rounded text-[10px] bg-white">
                                                    ${AUDIENCE_OPTIONS.map(opt => `<option ${a.audience === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                                </select>
                                            </td>
                                            <td class="px-4 py-3">
                                                <select onchange="window.saveField('${a.id}', 'eventSector', this.value)" class="w-full p-1 border rounded text-[10px] bg-white">
                                                    ${CRISIS_SECTOR_OPTIONS.map(opt => `<option ${a.eventSector === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                                </select>
                                            </td>
                                            <td class="px-4 py-3">
                                                <textarea onblur="window.saveField('${a.id}', 'postOccurrence', this.value)" class="w-full p-1 border rounded text-[10px] h-12" placeholder="Notas...">${a.postOccurrence || ''}</textarea>
                                            </td>
                                            <td class="px-4 py-3">
                                                <div class="flex items-center gap-1">
                                                    <input type="number" value="${a.satisfaction || ''}" onblur="window.saveField('${a.id}', 'satisfaction', this.value)" class="w-10 border rounded p-1 text-center font-bold" min="0" max="100">
                                                    <span class="text-[9px] text-gray-400">%</span>
                                                </div>
                                            </td>
                                            <td class="px-4 py-3">
                                                <select onchange="window.saveField('${a.id}', 'status', this.value)" class="w-full p-1 rounded font-bold text-[10px] border-none ${a.status === 'Concluído' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                                    ${['Planejado','Em Execução','Concluído','Cancelado'].map(s => `<option ${a.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                                                </select>
                                            </td>
                                            <td class="px-4 py-3 text-right no-print">
                                                <button onclick="window.requestDeleteActivity('${a.id}')" class="text-gray-300 hover:text-red-500 transition"><i data-lucide="trash-2" size="16"></i></button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        ${filteredActs.length === 0 ? '<div class="p-10 text-center text-gray-400 italic">Sem ações registadas para este mês. Clique em "Adicionar Ação".</div>' : ''}
                    </div>
                </div>
            `;
        };

        const getCalendarViewHTML = () => {
            return `
                <div class="space-y-6 animate-fadeIn">
                    <div class="flex justify-between items-center border-b pb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Calendário Consolidado 2026</h2>
                        <button onclick="window.exportPDF()" class="no-print bg-gray-800 text-white px-3 py-1.5 rounded flex gap-2 items-center text-sm"><i data-lucide="printer" size="14"></i> Imprimir Tudo</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${MONTHS_DATA.map(m => {
                            const mActs = window.state.activities.filter(a => parseInt(a.month) === m.id);
                            return `
                                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden flex flex-col h-auto min-h-[160px] print-break-inside-avoid">
                                    <div class="px-4 py-2 ${m.color} bg-gray-50 border-b border-gray-100 flex justify-between items-center">
                                        <h3 class="font-bold text-gray-700">${m.name}</h3>
                                        <span class="text-[10px] font-bold bg-white border px-2 py-0.5 rounded-full text-gray-500">${mActs.length}</span>
                                    </div>
                                    <div class="p-3 flex-1">
                                        <ul class="space-y-1">
                                            ${mActs.map(a => `<li class="text-[10px] flex items-start gap-1.5"><span class="w-1.5 h-1.5 rounded-full mt-1 flex-shrink-0 ${a.status === 'Concluído' ? 'bg-green-500' : 'bg-blue-400'}"></span><span class="truncate">${a.eventName || 'Sem nome'}</span></li>`).join('') || '<li class="text-[10px] text-gray-300 italic">Sem eventos</li>'}
                                        </ul>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        };

        const getCrisisViewHTML = () => {
            const crises = window.state.crises;
            return `
                <div class="space-y-6 animate-fadeIn">
                    <div class="bg-red-900 text-white p-6 rounded-lg shadow-lg flex justify-between items-center no-print">
                        <div><h2 class="text-2xl font-bold mb-1 flex items-center gap-2"><i data-lucide="shield-alert"></i> Gestão de Riscos</h2><p class="text-red-200 text-sm">Monitoramento preventivo e gestão de crises.</p></div>
                        <button onclick="window.addCrisis()" class="bg-white text-red-900 px-6 py-3 rounded-lg font-bold uppercase tracking-wider shadow hover:bg-gray-100 transition">Registar Ocorrência</button>
                    </div>
                    <div class="grid gap-6">
                        ${crises.map((c, i) => `
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 relative print-break-inside-avoid">
                                <button onclick="window.requestDeleteCrisis('${c.id}')" class="absolute top-4 right-4 text-gray-300 hover:text-red-500 no-print"><i data-lucide="trash-2" size="18"></i></button>
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 border-b pb-4">
                                    <div><label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Data</label><input type="date" value="${c.date}" onchange="window.saveCrisisField('${c.id}', 'date', this.value)" class="w-full border rounded p-1.5 text-sm"></div>
                                    <div><label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Nível de Risco</label><select onchange="window.saveCrisisField('${c.id}', 'riskLevel', this.value)" class="w-full border rounded p-1.5 text-sm font-bold">
                                        ${RISK_LEVELS.map(r => `<option ${c.riskLevel === r ? 'selected' : ''}>${r}</option>`).join('')}
                                    </select></div>
                                    <div><label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Setor</label><select onchange="window.saveCrisisField('${c.id}', 'sector', this.value)" class="w-full border rounded p-1.5 text-sm">
                                        ${CRISIS_SECTOR_OPTIONS.map(s => `<option ${c.sector === s ? 'selected' : ''}>${s}</option>`).join('')}
                                    </select></div>
                                    <div><label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Responsável</label><select onchange="window.saveCrisisField('${c.id}', 'responsible', this.value)" class="w-full border rounded p-1.5 text-sm">
                                        ${RESPONSIBLE_OPTIONS.map(r => `<option ${c.responsible === r ? 'selected' : ''}>${r}</option>`).join('')}
                                    </select></div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="p-3 bg-red-50 rounded border border-red-100"><label class="block text-[10px] font-bold text-red-800 uppercase mb-2">Plano de Ação Corretiva</label><textarea onblur="window.saveCrisisField('${c.id}', 'correctiveAction', this.value)" class="w-full bg-white border-none rounded p-2 text-sm h-24 shadow-inner">${c.correctiveAction || ''}</textarea></div>
                                    <div class="grid grid-cols-1 gap-2">
                                        <div class="p-2 bg-gray-50 rounded border border-gray-100"><label class="block text-[9px] font-bold text-gray-500 uppercase">Riscos Envolvidos</label><textarea onblur="window.saveCrisisField('${c.id}', 'risks', this.value)" class="w-full bg-transparent border-none text-xs h-12">${c.risks || ''}</textarea></div>
                                        <div class="p-2 bg-blue-50 rounded border border-blue-100"><label class="block text-[9px] font-bold text-blue-500 uppercase">Aprendizados</label><textarea onblur="window.saveCrisisField('${c.id}', 'learning', this.value)" class="w-full bg-transparent border-none text-xs h-12">${c.learning || ''}</textarea></div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        };

        const getReportsViewHTML = () => {
            const m = MONTHS_DATA[window.state.selectedMonth];
            const acts = window.state.activities.filter(a => parseInt(a.month) === m.id);
            const total = acts.length;
            const done = acts.filter(a => a.status === 'Concluído').length;
            const rep = window.state.monthlyReports[m.id] || { explanation: '', highlights: '' };

            return `
                <div class="space-y-8 animate-fadeIn max-w-5xl mx-auto">
                    <div class="flex justify-between items-center border-b pb-4">
                        <div><h2 class="text-2xl font-bold text-gray-800">Relatório Executivo</h2><p class="text-gray-500 font-medium">Referência: <span class="text-blue-600 uppercase">${m.name} 2026</span></p></div>
                        <div class="flex gap-2 no-print">
                            <button onclick="window.exportPDF()" class="bg-indigo-600 text-white px-4 py-2 rounded font-bold shadow-md hover:bg-indigo-700 transition">Gerar PDF para Gestão</button>
                            <button onclick="window.requestClearReport()" class="bg-red-50 text-red-600 px-4 py-2 rounded font-bold hover:bg-red-100 transition">Limpar</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="p-5 bg-gray-50 rounded-xl text-center border"><span class="text-3xl font-black text-gray-800 block">${total}</span><span class="text-[10px] font-bold text-gray-500 uppercase">Meta Mensal</span></div>
                        <div class="p-5 bg-green-50 rounded-xl text-center border border-green-100"><span class="text-3xl font-black text-green-600 block">${done}</span><span class="text-[10px] font-bold text-green-700 uppercase">Concluídas</span></div>
                        <div class="p-5 bg-yellow-50 rounded-xl text-center border border-yellow-100"><span class="text-3xl font-black text-yellow-600 block">${total - done}</span><span class="text-[10px] font-bold text-yellow-700 uppercase">Pendentes</span></div>
                        <div class="p-5 bg-blue-50 rounded-xl text-center border border-blue-100"><span class="text-3xl font-black text-blue-600 block">${total > 0 ? Math.round((done/total)*100) : 0}%</span><span class="text-[10px] font-bold text-blue-700 uppercase">Eficiência</span></div>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-xl border shadow-sm">
                            <div class="flex justify-between mb-4 items-center"><h3 class="font-bold text-gray-800 text-lg uppercase tracking-tight">1. Análise de Resultados</h3><button onclick="window.autoGenText()" class="no-print bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-xs font-bold hover:bg-blue-100 transition">Gerar Texto Automático</button></div>
                            <textarea onblur="window.saveReport('${m.id}', 'explanation', this.value)" class="w-full border-2 border-gray-100 rounded-lg p-4 h-48 focus:border-blue-500 outline-none text-gray-700 leading-relaxed">${rep.explanation || ''}</textarea>
                        </div>
                        <div class="bg-white p-6 rounded-xl border shadow-sm">
                            <h3 class="font-bold text-gray-800 text-lg uppercase tracking-tight mb-4">2. Destaques Positivos</h3>
                            <textarea onblur="window.saveReport('${m.id}', 'highlights', this.value)" class="w-full border-2 border-gray-100 rounded-lg p-4 h-32 focus:border-green-500 outline-none text-gray-700">${rep.highlights || ''}</textarea>
                        </div>
                    </div>
                </div>
            `;
        };

        // --- LÓGICA DE NAVEGAÇÃO E DADOS ---

        window.renderApp = () => {
            const content = document.getElementById('app-content');
            if(!content) return;

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('nav-btn-active', btn.dataset.view === window.state.view);
                btn.classList.toggle('nav-btn-inactive', btn.dataset.view !== window.state.view);
            });

            let monthSelector = '';
            if (['month', 'reports'].includes(window.state.view)) {
                monthSelector = `
                    <div class="mb-8 overflow-x-auto pb-4 no-print custom-scrollbar">
                        <div class="flex gap-2 min-w-max">
                            ${MONTHS_DATA.map(m => `
                                <button onclick="window.changeMonth(${m.id})" class="px-5 py-2.5 rounded-full text-sm font-bold border transition-all ${window.state.selectedMonth === m.id ? 'bg-blue-900 text-white border-blue-900 shadow-md ring-2 ring-offset-2 ring-blue-900' : 'bg-white text-gray-600 border-gray-200 hover:border-gray-400'}">
                                    ${m.name}
                                </button>`).join('')}
                        </div>
                    </div>`;
            }

            let viewHTML = '';
            switch(window.state.view) {
                case 'dashboard': viewHTML = getDashboardHTML(); break;
                case 'month': viewHTML = getMonthViewHTML(); break;
                case 'calendar': viewHTML = getCalendarViewHTML(); break;
                case 'crisis': viewHTML = getCrisisViewHTML(); break;
                case 'reports': viewHTML = getReportsViewHTML(); break;
            }

            content.innerHTML = monthSelector + viewHTML;
            if(typeof lucide !== 'undefined') lucide.createIcons();
        };

        // --- EXPOSIÇÃO GLOBAL DE FUNÇÕES ---
        window.changeView = (v) => { window.state.view = v; window.renderApp(); };
        window.changeMonth = (m) => { window.state.selectedMonth = m; window.renderApp(); };
        window.toggleMobileMenu = () => document.getElementById('mobile-menu')?.classList.toggle('hidden');
        window.exportPDF = () => { setTimeout(() => window.print(), 100); };
        window.closeModal = () => document.getElementById('modal-overlay')?.classList.add('hidden');
        window.openConfirm = (msg, cb) => {
            const m = document.getElementById('modal-overlay'), t = document.getElementById('modal-message'), b = document.getElementById('modal-confirm-btn');
            t.innerText = msg; b.onclick = () => { cb(); window.closeModal(); }; m.classList.remove('hidden');
        };

        // --- DB OPERATIONS ---
        window.addActivity = async () => {
            const d = { month: window.state.selectedMonth, type: 'Evento Interno', eventName: '', audience: 'Interno', date: '', time: '', eventSector: 'Comunicação', postOccurrence: '', satisfaction: '', status: 'Planejado', createdAt: new Date().toISOString() };
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'activities'), d);
        };
        window.saveField = async (id, f, v) => await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'activities', id), { [f]: v });
        window.requestDeleteActivity = (id) => window.openConfirm("Deseja excluir esta ação?", () => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'activities', id)));

        window.addCrisis = async () => {
            const d = { date: new Date().toISOString().split('T')[0], riskLevel: 'Sem relevância crítica', sector: 'Comunicação', responsible: 'Vera Nascimento', correctiveAction: '', risks: '', learning: '', createdAt: new Date().toISOString() };
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'crises'), d);
        };
        window.saveCrisisField = async (id, f, v) => await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'crises', id), { [f]: v });
        window.requestDeleteCrisis = (id) => window.openConfirm("Excluir este registo de crise?", () => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'crises', id)));

        window.sendNotif = async () => {
            const i = document.getElementById('notif-input');
            if(i?.value.trim()) { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'notifications'), { text: i.value, timestamp: new Date().toISOString(), author: 'Admin' }); i.value = ''; }
        };
        window.deleteNotification = async (id) => await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'notifications', id));

        window.addHoliday = async () => {
            const d = document.getElementById('h-day')?.value, n = document.getElementById('h-name')?.value;
            if(d && n) await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'holidays'), { month: window.state.selectedMonth, day: d, name: n });
        };
        window.removeHoliday = async (id) => await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'holidays', id));

        window.saveReport = async (m, f, v) => await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reports', m.toString()), { [f]: v }, { merge: true });
        window.requestClearReport = () => window.openConfirm("Limpar relatório?", () => setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reports', window.state.selectedMonth.toString()), { explanation: '', highlights: '' }));
        window.autoGenText = () => {
            const m = MONTHS_DATA[window.state.selectedMonth].name;
            const acts = window.state.activities.filter(a => parseInt(a.month) === window.state.selectedMonth);
            const done = acts.filter(a => a.status === 'Concluído').length;
            const txt = `ANÁLISE DE ENTREGAS - ${m.toUpperCase()}\n\nO mês encerrou com ${acts.length} ações planeadas e ${done} metas atingidas. Eficiência operacional de ${acts.length > 0 ? Math.round((done/acts.length)*100) : 0}%.`;
            window.saveReport(window.state.selectedMonth, 'explanation', txt);
        };
        window.handleSave = () => {
            const b = event.target.closest('button'), t = b.innerHTML;
            b.innerHTML = '<i data-lucide="cloud-check"></i> Sincronizado!';
            b.classList.add('bg-green-700');
            setTimeout(() => { b.innerHTML = t; b.classList.remove('bg-green-700'); lucide.createIcons(); }, 2000);
        };

        // --- INICIALIZAÇÃO ---
        async function init() {
            const dateEl = document.getElementById('print-date');
            if(dateEl) dateEl.innerText = new Date().toLocaleDateString();

            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) { console.error("Auth Error", e); }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    document.getElementById('connection-status-dot')?.classList.replace('bg-gray-400', 'bg-green-500');
                    document.getElementById('user-display').innerText = 'Painel Sincronizado';
                    document.getElementById('loading-spinner')?.classList.add('hidden');
                    
                    // Listeners Unificados
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'activities'), s => { window.state.activities = s.docs.map(d => ({id: d.id, ...d.data()})); window.renderApp(); });
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'crises'), s => { window.state.crises = s.docs.map(d => ({id: d.id, ...d.data()})); window.renderApp(); });
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'notifications'), s => { window.state.notifications = s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp)); window.renderApp(); });
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'holidays'), s => { window.state.holidays = s.docs.map(d => ({id: d.id, ...d.data()})); window.renderApp(); });
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'reports'), s => { const r = {}; s.docs.forEach(d => r[d.id] = d.data()); window.state.monthlyReports = r; window.renderApp(); });
                }
            });
        }

        init();
    </script>
</body>
</html>
