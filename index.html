
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==========================================================
    // FUNÇÕES DE VALIDAÇÃO (Regras de Negócio Atualizadas)
    // ==========================================================

    // Valida os Tipos de Eventos (Atualizado com 'TI' e 'Gravação Externa')
    function isValidEventType(type) {
      return type in [
        'TI', 
        'Evento Interno', 
        'Evento Externo', 
        'Campanha', 
        'Treinamento', 
        'Gravação Externa'
      ];
    }

    // Valida os Públicos (Novas opções incluídas)
    function isValidAudience(audience) {
      return audience in [
        'Externo', 
        'Interno', 
        'Parceria', 
        'Visitante', 
        'Colaborador'
      ];
    }

    // Valida os Status permitidos
    function isValidStatus(status) {
      return status in [
        'Planejado', 
        'Em Execução', 
        'Concluído', 
        'Cancelado'
      ];
    }

    // Valida os Níveis de Risco (Módulo de Crises)
    function isValidRiskLevel(level) {
      return level in [
        'Sem relevância crítica', 
        'Leve', 
        'Moderada', 
        'Potencial', 
        'Grave', 
        'Reputacional Extrema'
      ];
    }

    // Valida a Origem da Crise
    function isValidOrigin(origin) {
      return origin in ['Interno', 'Externo', 'Misto'];
    }

    // Valida os Setores Envolvidos na Crise
    function isValidSector(sector) {
      return sector in [
        'Comunicação', 
        'Central', 
        'Infraestrutura', 
        'Administração', 
        'RH', 
        'Externo'
      ];
    }

    // Valida os Responsáveis Autorizados
    function isValidResponsible(name) {
      return name in ['Vera Nascimento', 'Gisely Rocha'];
    }

    // ==========================================================
    // REGRAS POR COLEÇÃO
    // ==========================================================

    // 1. Ações do Mês (activities)
    match /activities/{activityId} {
      // Leitura permitida para todos (ajuste conforme necessário para autenticação)
      allow read: if true; 
      
      allow create, update: if 
        // Validação dos campos de seleção obrigatórios
        isValidEventType(request.resource.data.type) &&
        isValidAudience(request.resource.data.audience) &&
        isValidStatus(request.resource.data.status) &&
        // Validação opcional da satisfação (0 a 100)
        (
          !('satisfaction' in request.resource.data) || 
          request.resource.data.satisfaction == null ||
          request.resource.data.satisfaction == "" ||
          (request.resource.data.satisfaction
